<div class="min-h-screen bg-theme-background flex flex-col">
  <app-header 
    [config]="headerConfig"
    (profileClick)="navigateToProfile()"
    (adminClick)="navigateToAdmin()"
    (logoutClick)="logout()">
  </app-header>

  <main class="flex-grow p-6">
    <app-alert 
      [message]="alertMessage" 
      [type]="alertType"
      (dismissed)="onAlertDismissed()">
    </app-alert>

    <!-- Tab Navigation -->
    <div class="mb-6">
      <nav class="flex space-x-8">
        <button 
          *ngIf="hasAdminPrivileges()"
          (click)="setActiveTab('users')"
          [class]="'py-2 px-1 border-b-2 font-medium text-sm transition-colors ' + 
            (activeTab === 'users' ? 
              'border-theme-primary text-theme-primary' : 
              'border-transparent text-theme-text-secondary hover:text-theme-text hover:border-theme-border')"
        >
          Users
        </button>
        <button 
          *ngIf="hasOrganizationAccess()"
          (click)="setActiveTab('organizations')"
          [class]="'py-2 px-1 border-b-2 font-medium text-sm transition-colors ' + 
            (activeTab === 'organizations' ? 
              'border-theme-primary text-theme-primary' : 
              'border-transparent text-theme-text-secondary hover:text-theme-text hover:border-theme-border')"
        >
          Organizations
        </button>
        <button 
          *ngIf="hasBusinessUnitAccess()"
          (click)="setActiveTab('business-units')"
          [class]="'py-2 px-1 border-b-2 font-medium text-sm transition-colors ' + 
            (activeTab === 'business-units' ? 
              'border-theme-primary text-theme-primary' : 
              'border-transparent text-theme-text-secondary hover:text-theme-text hover:border-theme-border')"
        >
          Business Units
        </button>
      </nav>
    </div>

    <!-- Users Tab Content -->
    <div *ngIf="activeTab === 'users' && hasAdminPrivileges()" class="bg-theme-surface rounded-lg shadow-md p-6 border border-theme-border">
      <!-- User Management Section -->
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold text-theme-text">Existing Users</h3>
        <button (click)="navigateToCreateUser()" class="w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-theme-primary-text bg-theme-primary hover:bg-theme-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-theme-border-focus transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Create New User
        </button>
      </div>

      <!-- Organization and Business Unit Filter Section (only for admin and super_user) -->
      <div *ngIf="hasFullAdminAccess()" class="mb-6 p-4 bg-theme-surface-hover border border-theme-border rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Organization Filter -->
          <div>
            <label for="userOrganizationFilter" class="block text-sm font-medium text-theme-text mb-2">
              Filter by Organization
            </label>
            <select 
              id="userOrganizationFilter"
              [(ngModel)]="selectedUserOrganizationId" 
              (change)="onUserOrganizationFilterChange()"
              class="w-full px-3 py-2 border border-theme-border rounded-md shadow-sm bg-theme-surface text-theme-text focus:outline-none focus:ring-2 focus:ring-theme-primary focus:border-theme-primary">
              <option value="" disabled>Select Organization</option>
              <option *ngFor="let org of organizations" [value]="org.id">
                {{ org.company_name }}
              </option>
            </select>
          </div>

          <!-- Business Unit Filter -->
          <div>
            <label for="userBusinessUnitFilter" class="block text-sm font-medium text-theme-text mb-2">
              Filter by Business Unit
            </label>
            <select 
              id="userBusinessUnitFilter"
              [(ngModel)]="selectedUserBusinessUnitId" 
              (change)="onUserBusinessUnitFilterChange()"
              [disabled]="!selectedUserOrganizationId"
              class="w-full px-3 py-2 border border-theme-border rounded-md shadow-sm bg-theme-surface text-theme-text focus:outline-none focus:ring-2 focus:ring-theme-primary focus:border-theme-primary disabled:bg-theme-surface-hover disabled:text-theme-text-muted disabled:cursor-not-allowed">
              <option value="" disabled>Select Business Unit</option>
              <option *ngFor="let unit of filteredUserBusinessUnits" [value]="unit.id">
                {{ unit.name }}
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Business Unit Filter Section (only for firm_admin) -->
      <div *ngIf="isFirmAdmin()" class="mb-6 p-4 bg-theme-surface-hover border border-theme-border rounded-lg">
        <div>
          <label for="firmAdminBusinessUnitFilter" class="block text-sm font-medium text-theme-text mb-2">
            Filter by Business Unit
          </label>
          <select 
            id="firmAdminBusinessUnitFilter"
            [(ngModel)]="selectedFirmAdminBusinessUnitId" 
            (change)="onFirmAdminBusinessUnitFilterChange()"
            class="w-full max-w-md px-3 py-2 border border-theme-border rounded-md shadow-sm bg-theme-surface text-theme-text focus:outline-none focus:ring-2 focus:ring-theme-primary focus:border-theme-primary">
            <option value="" disabled>Select Business Unit</option>
            <option *ngFor="let unit of firmAdminBusinessUnits" [value]="unit.id">
              {{ unit.name }}
            </option>
          </select>
        </div>
      </div>

      <!-- Show users table based on role-specific conditions -->
      <div *ngIf="shouldShowUsersTable()" class="overflow-x-auto">
        <table class="min-w-full bg-theme-surface border border-theme-border rounded-md">
            <thead>
              <tr class="bg-theme-surface-hover text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider">
                <th class="py-3 px-6">Name</th>
                <th class="py-3 px-6">Email</th>
                <th class="py-3 px-6">Admin</th>
                <th class="py-3 px-6">Role</th>
                <th class="py-3 px-6">Business Unit</th>
                <th class="py-3 px-6">Organization</th>
                <th class="py-3 px-6">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-theme-border">
              <tr *ngFor="let user of filteredUsers; let i = index" [ngClass]="{'bg-theme-surface-hover': i % 2 === 1}">
                <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">
                  {{ (user.first_name && user.last_name) ? (user.first_name + ' ' + user.last_name) : (user.first_name || user.last_name || '-') }}
                </td>
                <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ user.email }}</td>
                <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ user.roles.includes(ADMIN_ROLE) ? 'Yes' : 'No' }}</td>
                <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">
                  <span *ngIf="user.roles.length > 0">{{ user.roles[0] }}</span>
                  <span *ngIf="user.roles.length === 0" class="text-theme-text-muted">None</span>
                </td>
                <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">
                  <span *ngIf="user.business_unit_name">{{ user.business_unit_name }}</span>
                  <span *ngIf="!user.business_unit_name" class="text-theme-text-muted">-</span>
                </td>
                <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">
                  <span *ngIf="user.organization_name">{{ user.organization_name }}</span>
                  <span *ngIf="!user.organization_name" class="text-theme-text-muted">-</span>
                </td>
                <td class="py-4 px-6 whitespace-nowrap text-sm font-medium">
                  <!-- Edit button - enabled only if user has permission -->
                  <button 
                    *ngIf="canEditUser(user)" 
                    (click)="editUser(user)" 
                    class="inline-flex items-center text-theme-primary hover:text-theme-primary-hover mr-4 p-1 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    <span class="text-xs">Edit</span>
                  </button>
                  <!-- Disabled edit button for restricted users -->
                  <span 
                    *ngIf="!canEditUser(user)" 
                    class="inline-flex items-center text-theme-text-muted cursor-not-allowed mr-4 p-1 opacity-50"
                    title="You don't have permission to edit this user">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    <span class="text-xs">Edit</span>
                  </span>
                  <button (click)="deleteUser(user.id)" class="inline-flex items-center text-theme-error hover:text-theme-error/80 mr-4 p-1 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span class="text-xs">Delete</span>
                  </button>
                  <!-- Conditional MFA Button -->
                  <button *ngIf="!user.mfa_enabled" (click)="setupMfa(user)" class="inline-flex items-center text-theme-primary hover:text-theme-primary-hover p-1 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <span class="text-xs">Setup MFA</span>
                  </button>
                  <button *ngIf="user.mfa_enabled" (click)="removeMfa(user)" class="inline-flex items-center text-theme-error hover:text-theme-error/80 p-1 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span class="text-xs">Remove MFA</span>
                  </button>
                </td>
              </tr>
              <tr *ngIf="filteredUsers.length === 0 && (selectedUserBusinessUnitId || selectedFirmAdminBusinessUnitId)">
                <td colspan="7" class="py-4 px-6 text-center text-theme-text-muted">No users found for the selected business unit.</td>
              </tr>
              <tr *ngIf="filteredUsers.length === 0 && !selectedUserBusinessUnitId && !selectedFirmAdminBusinessUnitId && isGroupAdmin()">
                <td colspan="7" class="py-4 px-6 text-center text-theme-text-muted">No users found.</td>
              </tr>
            </tbody>
          </table>
        </div>

      <!-- Show instruction message when filters are not selected -->
      <div *ngIf="!shouldShowUsersTable()" class="text-center py-12">
        <div class="bg-theme-surface-hover border border-theme-border rounded-lg p-8">
          <svg class="mx-auto h-12 w-12 text-theme-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
          <h3 class="text-lg font-medium text-theme-text mb-2">
            <!-- Admin/Super_user messages -->
            <span *ngIf="hasFullAdminAccess() && !selectedUserOrganizationId">Select an Organization</span>
            <span *ngIf="hasFullAdminAccess() && selectedUserOrganizationId && !selectedUserBusinessUnitId">Select a Business Unit</span>
            <!-- Firm_admin message -->
            <span *ngIf="isFirmAdmin() && !selectedFirmAdminBusinessUnitId">Select a Business Unit</span>
          </h3>
          <p class="text-theme-text-secondary">
            <!-- Admin/Super_user messages -->
            <span *ngIf="hasFullAdminAccess() && !selectedUserOrganizationId">Please select an organization from the dropdown above to view business units.</span>
            <span *ngIf="hasFullAdminAccess() && selectedUserOrganizationId && !selectedUserBusinessUnitId">Please select a business unit from the dropdown above to view users.</span>
            <!-- Firm_admin message -->
            <span *ngIf="isFirmAdmin() && !selectedFirmAdminBusinessUnitId">Please select a business unit from the dropdown above to view users.</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Organizations Tab Content -->
    <div *ngIf="activeTab === 'organizations' && hasOrganizationAccess()" class="bg-theme-surface rounded-lg shadow-md p-6 border border-theme-border">
      <!-- Organizations Management Section -->
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold text-theme-text">Organizations</h3>
        <button (click)="navigateToCreateOrganization()" class="w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-theme-primary-text bg-theme-primary hover:bg-theme-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-theme-border-focus transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Create New Organization
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-theme-surface border border-theme-border rounded-md">
          <thead>
            <tr class="bg-theme-surface-hover text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider">
              <th class="py-3 px-6">Company Name</th>
              <th class="py-3 px-6">Email</th>
              <th class="py-3 px-6">Phone</th>
              <th class="py-3 px-6">City</th>
              <th class="py-3 px-6">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-theme-border">
            <tr *ngFor="let org of organizations; let i = index" [ngClass]="{'bg-theme-surface-hover': i % 2 === 1}">
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ org.company_name }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ org.email || '-' }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ org.phone_number || '-' }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ org.city_town || '-' }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm font-medium">
                <button (click)="editOrganization(org)" class="inline-flex items-center text-theme-primary hover:text-theme-primary-hover mr-4 p-1 transition-colors">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                  <span class="text-xs">Edit</span>
                </button>
                <button (click)="deleteOrganization(org.id)" class="inline-flex items-center text-theme-error hover:text-theme-error/80 p-1 transition-colors">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  <span class="text-xs">Delete</span>
                </button>
              </td>
            </tr>
            <tr *ngIf="organizations.length === 0">
              <td colspan="5" class="py-4 px-6 text-center text-theme-text-muted">No organizations found.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Business Units Tab Content -->
    <div *ngIf="activeTab === 'business-units' && hasBusinessUnitAccess()" class="bg-theme-surface rounded-lg shadow-md p-6 border border-theme-border">
      <!-- Business Units Management Section -->
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold text-theme-text">Business Units</h3>
        <button (click)="navigateToCreateBusinessUnit()" class="w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-theme-primary-text bg-theme-primary hover:bg-theme-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-theme-border-focus transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Create New Business Unit
        </button>
      </div>

      <!-- Organization Filter Section (only for admin and super_user) -->
      <div *ngIf="hasFullAdminAccess()" class="mb-6 p-4 bg-theme-surface-hover border border-theme-border rounded-lg">
        <label for="organizationFilter" class="block text-sm font-medium text-theme-text mb-2">
          Filter by Organization
        </label>
        <select 
          id="organizationFilter"
          [(ngModel)]="selectedOrganizationId" 
          (change)="onOrganizationFilterChange()"
          class="w-full max-w-md px-3 py-2 border border-theme-border rounded-md shadow-sm bg-theme-surface text-theme-text focus:outline-none focus:ring-2 focus:ring-theme-primary focus:border-theme-primary">
          <option value="" disabled>Select Organization</option>
          <option *ngFor="let org of organizations" [value]="org.id">
            {{ org.company_name }}
          </option>
        </select>
      </div>

      <!-- Show business units table only when organization is selected (for admin/super_user) or always for other roles -->
      <div *ngIf="!hasFullAdminAccess() || (hasFullAdminAccess() && selectedOrganizationId)" class="overflow-x-auto">
        <table class="min-w-full bg-theme-surface border border-theme-border rounded-md">
          <thead>
            <tr class="bg-theme-surface-hover text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider">
              <th class="py-3 px-6">Name</th>
              <th class="py-3 px-6">Organization</th>
              <th class="py-3 px-6">Parent Unit</th>
              <th class="py-3 px-6">Manager</th>
              <th class="py-3 px-6">Location</th>
              <th class="py-3 px-6">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-theme-border">
            <tr *ngFor="let unit of filteredBusinessUnits; let i = index" [ngClass]="{'bg-theme-surface-hover': i % 2 === 1}">
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ unit.name }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ unit.organization_name || '-' }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ unit.parent_name || '-' }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ unit.manager_name || '-' }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm text-theme-text">{{ unit.location || '-' }}</td>
              <td class="py-4 px-6 whitespace-nowrap text-sm font-medium">
                <button (click)="navigateToEditBusinessUnit(unit)" class="inline-flex items-center text-theme-primary hover:text-theme-primary-hover mr-4 p-1 transition-colors">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                  <span class="text-xs">Edit</span>
                </button>
                <button (click)="deleteBusinessUnit(unit.id)" class="inline-flex items-center text-theme-error hover:text-theme-error/80 p-1 transition-colors">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  <span class="text-xs">Delete</span>
                </button>
              </td>
            </tr>
            <tr *ngIf="filteredBusinessUnits.length === 0 && selectedOrganizationId">
              <td colspan="6" class="py-4 px-6 text-center text-theme-text-muted">No business units found for the selected organization.</td>
            </tr>
            <tr *ngIf="filteredBusinessUnits.length === 0 && !selectedOrganizationId && !hasFullAdminAccess()">
              <td colspan="6" class="py-4 px-6 text-center text-theme-text-muted">No business units found.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Show instruction message when no organization is selected (for admin/super_user only) -->
      <div *ngIf="hasFullAdminAccess() && !selectedOrganizationId" class="text-center py-12">
        <div class="bg-theme-surface-hover border border-theme-border rounded-lg p-8">
          <svg class="mx-auto h-12 w-12 text-theme-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
          <h3 class="text-lg font-medium text-theme-text mb-2">Select an Organization</h3>
          <p class="text-theme-text-secondary">Please select an organization from the dropdown above to view its business units.</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Confirmation Modal -->
  <div *ngIf="showConfirmModal" class="fixed inset-0 bg-theme-modal-overlay overflow-y-auto h-full w-full z-50" (click)="closeConfirmModal()">
    <div class="relative top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border border-theme-border w-11/12 md:w-96 shadow-xl rounded-lg bg-theme-surface overflow-hidden" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="bg-theme-primary text-theme-primary-text p-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 rounded-full bg-theme-primary-hover flex items-center justify-center">
            <svg class="w-5 h-5 text-theme-primary-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-theme-primary-text">{{ confirmTitle }}</h3>
        </div>
        <button (click)="closeConfirmModal()" class="text-theme-primary-text/80 hover:text-theme-primary-text focus:outline-none transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="p-6">
        <p class="text-sm text-theme-text-secondary mb-6">{{ confirmMessage }}</p>
        
        <!-- Modal Footer -->
        <div class="flex justify-end space-x-3">
          <button (click)="closeConfirmModal()" class="px-4 py-2 bg-theme-secondary text-theme-primary-text rounded-md hover:bg-theme-secondary-hover transition-colors">
            Cancel
          </button>
          <button (click)="confirmAction()" class="px-4 py-2 bg-theme-error text-theme-primary-text rounded-md hover:bg-theme-error/80 transition-colors">
            {{ confirmButtonText }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MFA Setup Modal -->
  <div *ngIf="showMfaSetupModal" class="fixed inset-0 bg-theme-modal-overlay overflow-y-auto h-full w-full z-50" (click)="closeMfaSetupModal()">
    <div class="relative top-20 mx-auto p-5 border border-theme-border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-theme-surface" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="flex items-center justify-between pb-4 border-b border-theme-border">
        <h3 class="text-lg font-semibold text-theme-text">MFA Setup</h3>
        <button (click)="closeMfaSetupModal()" class="text-theme-text-muted hover:text-theme-text-secondary focus:outline-none transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="py-4">
        <div class="mb-6">
          <p class="text-sm text-theme-text-secondary mb-4">
            Set up Multi-Factor Authentication for <strong>{{ selectedUserForMfa?.email }}</strong>
          </p>
        </div>
        
        <!-- Secret Key Section -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-theme-text-secondary mb-2">Secret Key</label>
          <div class="bg-theme-surface-hover border border-theme-border rounded-md p-3">
            <div class="flex items-center justify-between">
              <code class="text-sm text-theme-text break-all">{{ mfaSecret }}</code>
              <button (click)="copyToClipboard(mfaSecret || '')" class="ml-2 text-theme-primary hover:text-theme-primary-hover text-sm transition-colors">
                Copy
              </button>
            </div>
          </div>
        </div>
        
        <!-- QR Code Section -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-theme-text-secondary mb-2">QR Code</label>
          <div class="flex justify-center bg-theme-surface-hover border border-theme-border rounded-md p-4">
            <img [src]="'data:image/png;base64,' + mfaQrCodeBase64" alt="MFA QR Code" class="max-w-64 max-h-64" />
          </div>
          <p class="text-xs text-theme-text-muted mt-2 text-center">
            Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)
          </p>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="flex justify-end pt-4 border-t border-theme-border">
        <button (click)="closeMfaSetupModal()" class="w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-theme-primary-text bg-theme-primary hover:bg-theme-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-theme-border-focus transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

</div>